<!doctype html>
<html>
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BPYMG0BNRP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-BPYMG0BNRP');
</script>

<!-- FAVICONS -->
<link rel="icon" type="image/png" href="/geofavicon/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="/geofavicon/favicon.svg" />
<link rel="shortcut icon" href="/geofavicon/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/geofavicon/apple-touch-icon.png" />
<link rel="manifest" href="/geofavicon/site.webmanifest" />

<meta charset="utf-8" />
<title>GeoBrawl — Map + Multiplayer + Street View</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />

<style>
  :root {
    --bg: #11284B;
    --text-light: #E8E8E8;
    --text-accent: #4A90D6;
    --panel: #1A355F;
    --panel-border: #0A1630;
    --button: #4A90D6;
    --button-hover: #2F6CB0;
  }

  body {
    font-family: system-ui, Arial;
    margin:0;
    padding:20px;
    background: var(--bg);
    display:flex;
    justify-content:center;
    color: var(--text-light);
  }

  /* LEFT PANEL (Main content area) */
  #left {
    width: 100%;
    max-width: 500px;
  }

  #logo {
    width: 160px;
    height: auto;
    display:block;
    margin: 0 auto 8px auto;
    filter: drop-shadow(0 0 8px rgba(0,0,0,0.5));
  }

  h2 {
    text-align:center;
    color: var(--text-accent);
    font-size: 2.2rem;
    margin-bottom: 6px;
  }

  .panel {
    background: var(--panel);
    padding:14px;
    border-radius:12px;
    margin-bottom:16px;
    border: 1px solid var(--panel-border);
    box-shadow:0 2px 6px rgba(0,0,0,0.35);
  }
  #roomInput {
  width: 100%;              /* full width like buttons */
  padding: 10px 12px;       /* same padding as buttons */
  margin: 8px 0;            /* spacing like buttons */
  border-radius: 8px;       /* match buttons */
  border: 1px solid #3c5d8f; /* subtle border */
  background: white;        /* white background */
  color: black;             /* black text */
  font-size: 1rem;          /* match button font size */
  font-weight: 600;         /* match button font weight */
  text-align: center;       /* center text */
  box-sizing: border-box;   /* ensures width includes padding */
}

#roomInput::placeholder {
  color: #555;              /* gray placeholder text */
  text-align: center;       /* center placeholder text too */
}

  button {
    width:100%;
    background: var(--button);
    color:white;
    border:none;
    padding:10px 12px;
    border-radius:8px;
    font-size:1rem;
    font-weight:600;
    margin-top:8px;
    cursor:pointer;
    transition:0.2s;
  }

  button:hover {
    background: var(--button-hover);
    transform: translateY(-2px);
  }

  input[type="text"] {
    width:100%;
    padding:9px;
    margin-top:6px;
    border-radius:8px;
    border:1px solid #3c5d8f;
    background:#0F223F;
    color:white;
    box-sizing:border-box;
  }

  #pickerMapContainer, #guesserMapContainer {
    margin-top:10px;
  }

  #map, #guessMap {
    width:100%;
    height:300px;
    border-radius:8px;
    background:#0A1630;
  }

  #guesserStreetView {
    width:100%;
    height:280px;
    border-radius:8px;
    background:#0A1630;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:bold;
    color:#9bb5ff;
    margin-bottom:8px;
  }

  .status { 
    font-weight:600; 
    margin-top:6px;
    color: var(--text-accent);
  }

  .hint { 
    font-size:0.9rem; 
    color:#cbd6ff; 
    margin-top:6px; 
  }
  

  /* Mobile */
  @media (max-width: 480px) {
    #map, #guessMap, #guesserStreetView {
      height: 240px;
    }
  }
  #playersList {
  list-style: none;
  padding-left: 0;
  margin: 4px 0;
}
#playersList li {
  padding: 4px 0;
}

</style>
</head>

<body>

<div id="left">

  <img id="logo" src="/geofavicon/logo.png" alt="GeoBrawl Logo">

  <h2>GeoBrawl</h2>

  <!-- Lobby -->
  <div class="panel" id="lobbyControls">
    <button id="createBtn">Create Room</button>

    <input id="roomInput" placeholder="Enter Room Code" />
    <button id="joinBtn">Join Room</button>

    <div class="hint">Open the same room in another browser to play (up to 10 players).</div>
  </div>

  <!-- Room -->
  <div class="panel" id="roomPanel" style="display:none;">
    <div>Room: <span id="roomIdSpan" style="color:var(--text-accent)"></span></div>
    <div>Players: <ul id="playersList"></ul></div>
    <div>Scores: <pre id="scoresPre"></pre></div>
    <div class="status" id="statusText">Waiting for players...</div>
  </div>

  <!-- Picker panel -->
<div class="panel" id="pickerPanel" style="display:none;">
  <h3 style="color:var(--text-accent)">Picker — Street View on Map</h3>
  <p>Move Street View on the map and click "Spot Chosen".</p>

  <input id="hintInput" placeholder="Optional hint (e.g. 'Near a famous river')" style="display:none;" />
  <button id="submitPickBtn" disabled>Spot Chosen</button>

  <div id="pickerMapContainer">
    <div id="map"></div>
  </div>

  <!-- Ad container for idle player -->
  <div id="pickerAdContainer" style="width:100%; height:100px; margin-top:10px; display:none;"></div>
</div>

<!-- Guesser panel -->
<div class="panel" id="guesserPanel" style="display:none;">
  <h3 style="color:var(--text-accent)">Guesser — Make your guess</h3>

  <div id="guesserStreetView">Waiting for picker to pick spot...</div>

  <div id="guesserMapContainer">
    <div id="guessMap"></div>
  </div>

  <div id="guessResult" style="margin-top:6px; font-weight:600;"></div>

  <button id="submitGuessBtn" disabled>Submit Guess</button>

  <!-- Ad container for idle player -->
  <div id="guesserAdContainer" style="width:100%; height:100px; margin-top:10px; display:none;"></div>
</div>

  <!-- Result -->
  <div class="panel" id="resultPanel" style="display:none;">
    <h3 style="color:var(--text-accent)">Round Result</h3>
    <div id="resultText"></div>
  </div>

</div>

<!-- Google Maps -->
<script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCQHZHmpF-9_7jEixW8z_h_-zbImwnI3S0&callback=initMaps"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<!-- ALL YOUR ORIGINAL JS (unchanged) -->
<script>
/* ------- Your JavaScript is unchanged except for layout ------- */

const SERVER_URL = "geo-production-f14c.up.railway.app";
const socket = io(SERVER_URL, { transports: ["websocket"] });

// DOM references
const createBtn = document.getElementById('createBtn');
const joinBtn = document.getElementById('joinBtn');
const roomInput = document.getElementById('roomInput');
const roomPanel = document.getElementById('roomPanel');
const roomIdSpan = document.getElementById('roomIdSpan');
const playersList = document.getElementById('playersList');
const scoresPre = document.getElementById('scoresPre');
const statusText = document.getElementById('statusText');
const pickerPanel = document.getElementById('pickerPanel');
const guesserPanel = document.getElementById('guesserPanel');
const submitPickBtn = document.getElementById('submitPickBtn');
const submitGuessBtn = document.getElementById('submitGuessBtn');
const hintInput = document.getElementById('hintInput');
const resultPanel = document.getElementById('resultPanel');
const resultText = document.getElementById('resultText');
const guesserStreetViewDiv = document.getElementById('guesserStreetView');
const guessMapDiv = document.getElementById('guessMap');
const guessResultDiv = document.getElementById('guessResult');

let myRoomId=null, mySocketId=null;
let players=[], scores={}, currentPickerId=null, usernames={};
let pickerMap, pickerStreetView, pickerLatLng=null;
let guessMap, guessMarker=null, guesserPanorama=null;

// Init maps with new DOM structure
function initMaps() {
pickerMap = new google.maps.Map(document.getElementById("map"), {
  center:{lat:20,lng:0},
  zoom:2,
  streetViewControl:true,
  gestureHandling: "greedy"
});

  pickerStreetView = pickerMap.getStreetView();
  pickerStreetView.setVisible(true);

  pickerStreetView.addListener("position_changed", () => {
    const pos = pickerStreetView.getPosition();
    pickerLatLng = { lat: pos.lat(), lng: pos.lng() };
    if(currentPickerId === mySocketId) submitPickBtn.disabled = false;
  });

  // Guess map
guessMap = new google.maps.Map(guessMapDiv, {
  center:{lat:20,lng:0},
  zoom:2,
  gestureHandling: "greedy"
});


  guessMap.addListener("click", e => {
    if(currentPickerId === mySocketId) return;
    const latLng = { lat:e.latLng.lat(), lng:e.latLng.lng() };

    if(guessMarker) guessMarker.setMap(null);
    guessMarker = new google.maps.Marker({ position:latLng, map:guessMap });

    submitGuessBtn.disabled = false;
    submitGuessBtn.onclick = () => {
      socket.emit("makeGuess",{roomId:myRoomId,lat:latLng.lat,lng:latLng.lng});
      submitGuessBtn.disabled = true;
    };
  });
}

submitPickBtn.onclick = () => {
  if(!pickerLatLng) return alert("Move Street View to pick a spot!");
  socket.emit("pickLocation",{roomId:myRoomId,lat:pickerLatLng.lat,lng:pickerLatLng.lng,hint:hintInput.value});
  submitPickBtn.disabled = true;
  submitPickBtn.textContent="Spot Chosen";
};

// Remaining socket logic kept exactly the same…
socket.on("connect",()=>mySocketId=socket.id);

createBtn.onclick = () => {
  socket.emit("createRoom",res=>{
    if(res.ok){
      myRoomId=res.roomId;
      roomIdSpan.textContent=myRoomId;
      roomPanel.style.display="";
      document.getElementById("lobbyControls").style.display="none";
    }
  });
};
// Show ad to idle player
function updateAds() {
  if(players.length < 2){
    // Show an ad while waiting for another player
    const container = document.getElementById("pickerAdContainer");
    container.style.display = "block";
    container.innerHTML = "<div style='width:100%; height:100px; background:#333; color:#fff; display:flex; align-items:center; justify-content:center;'>Ad placeholder while waiting for other player</div>";

    // Hide the guesser container just in case
    document.getElementById("guesserAdContainer").style.display = "none";
    return;
  }

  if(currentPickerId === mySocketId){
    // You are picker → show ad to guesser
    document.getElementById("pickerAdContainer").style.display = "none";
    document.getElementById("guesserAdContainer").style.display = "block";
    loadAd("guesserAdContainer");
  } else {
    // You are guesser → show ad to picker
    document.getElementById("pickerAdContainer").style.display = "block";
    document.getElementById("guesserAdContainer").style.display = "none";
    loadAd("pickerAdContainer");
  }
}

// Load ad placeholder (replace with real Google ad code later)
function loadAd(containerId){
  const container = document.getElementById(containerId);
  container.innerHTML = "<div style='width:100%; height:100%; background:#333; color:#fff; display:flex; align-items:center; justify-content:center;'>Ad placeholder (muted by default)</div>";
}
joinBtn.onclick = () => {
  const r = roomInput.value.trim().toUpperCase();
  if(!r) return alert("Enter a room code");
  socket.emit("joinRoom",r,res=>{
    if(!res.ok) return alert(res.err);
    myRoomId=r;
    roomIdSpan.textContent=myRoomId;
    roomPanel.style.display="";
    document.getElementById("lobbyControls").style.display="none";
  });
};

socket.on("roomJoined",data=>{
  players=data.players;
  scores=data.scores;
  currentPickerId=data.pickerSocketId;
  usernames=data.usernames || {};
  updateLobbyUI();
  updateRolePanels();
});

socket.on("startGuess",data=>{
  guesserPanel.style.display="";
  pickerPanel.style.display="none";
  statusText.textContent="Make your guess…";
  guesserStreetViewDiv.innerHTML="";

  guesserPanorama = new google.maps.StreetViewPanorama(guesserStreetViewDiv,{
    position:{lat:data.lat,lng:data.lng},
    pov:{heading:0,pitch:0},
    zoom:1,
    disableDefaultUI:true,
    clickToGo:false,
    linksControl:false
  });

  guessMap.setCenter({lat:20,lng:0});
  guessMap.setZoom(2);
  if(guessMarker) guessMarker.setMap(null);
  guessResultDiv.innerHTML="";
});

socket.on("roundResult",res=>{
  resultPanel.style.display="";
  resultText.innerHTML=`Distance: <b>${res.distanceMeters} m</b><br>Points: <b>${res.pointsAwarded}</b>`;
  scores=res.scores; updateScoresUI();

  new google.maps.Marker({
    position:{lat:res.correct.lat,lng:res.correct.lng},
    map:guessMap,
    icon:"http://maps.google.com/mapfiles/ms/icons/green-dot.png"
  });

  guessResultDiv.innerHTML=`Distance: <b>${res.distanceMeters} m</b> — Points: <b>${res.pointsAwarded}</b>`;
});

socket.on("newRound",data=>{
  currentPickerId=data.pickerSocketId;
  scores=data.scores;
  resultPanel.style.display="none";
  guesserStreetViewDiv.innerHTML="Waiting for picker to pick spot...";
  guessResultDiv.innerHTML="";
  if(guessMarker) guessMarker.setMap(null);
  guessMap.setCenter({lat:20,lng:0}); guessMap.setZoom(2);
  updateScoresUI(); updateRolePanels();
  updateAds(); // update ads for new round
});

function updateLobbyUI() {
  playersList.innerHTML = players
    .map(p => {
      const name = usernames[p] || p;
      return `<li>${p === mySocketId ? "You (" + name + ")" : name}</li>`;
    })
    .join("");
  updateScoresUI();
  
}
function updateScoresUI() {
  scoresPre.textContent = players
    .map(id => {
      const name = usernames[id] || id;
      const score = scores[id] || 0;
      return `${name}: ${score}`;
    })
    .join("\n");
}
  
function updateRolePanels() {
  if(players.length<2){
    pickerPanel.style.display="none";
    guesserPanel.style.display="none";
    statusText.textContent="Waiting for another player…";
    updateAds(); // hide ads
    return;
  }

  if(currentPickerId===mySocketId){
    statusText.textContent="You are the picker.";
    pickerPanel.style.display="";
    guesserPanel.style.display="none";
  } else {
    statusText.textContent="You are the guesser.";
    pickerPanel.style.display="none";
    guesserPanel.style.display="";
  }

  updateAds(); // show ad to idle player
}

</script>

</body>
</html>
