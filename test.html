<!doctype html>
<html>
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-BPYMG0BNRP"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-BPYMG0BNRP');
  </script>

  <!-- FAVICONS -->
  <link rel="icon" type="image/png" href="/geofavicon/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/geofavicon/favicon.svg" />
  <link rel="shortcut icon" href="/geofavicon/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/geofavicon/apple-touch-icon.png" />
  <link rel="manifest" href="/geofavicon/site.webmanifest" />

  <meta charset="utf-8" />
  <title>GeoBrawl — Map + Multiplayer + Street View</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <style>
    :root {
      --bg: #11284B;
      --text-light: #E8E8E8;
      --text-accent: #4A90D6;
      --panel: #1A355F;
      --panel-border: #0A1630;
      --button: #4A90D6;
      --button-hover: #2F6CB0;
    }

    body {
      font-family: system-ui, Arial;
      margin:0;
      padding:20px;
      background: var(--bg);
      display:flex;
      justify-content:center;
      color: var(--text-light);
    }

    /* LEFT PANEL (Main content area) */
    #left {
      width: 100%;
      max-width: 500px;
    }

    #logo {
      width: 160px;
      height: auto;
      display:block;
      margin: 0 auto 8px auto;
      filter: drop-shadow(0 0 8px rgba(0,0,0,0.5));
    }

    h2 {
      text-align:center;
      color: var(--text-accent);
      font-size: 2.2rem;
      margin-bottom: 6px;
    }

    .panel {
      background: var(--panel);
      padding:14px;
      border-radius:12px;
      margin-bottom:16px;
      border: 1px solid var(--panel-border);
      box-shadow:0 2px 6px rgba(0,0,0,0.35);
    }

    button {
      width:100%;
      background: var(--button);
      color:white;
      border:none;
      padding:10px 12px;
      border-radius:8px;
      font-size:1rem;
      font-weight:600;
      margin-top:8px;
      cursor:pointer;
      transition:0.2s;
    }

    button:hover {
      background: var(--button-hover);
      transform: translateY(-2px);
    }

    input[type="text"] {
      width:100%;
      padding:9px;
      margin-top:6px;
      border-radius:8px;
      border:1px solid #3c5d8f;
      background:#0F223F;
      color:white;
      box-sizing:border-box;
    }

    #pickerMapContainer, #guesserMapContainer {
      margin-top:10px;
    }

    /* explicit min-height (fixes grey map inside flex) */
    #map, #guessMap {
      width:100%;
      min-height:300px;
      height:300px;
      border-radius:8px;
      background:#0A1630;
    }

    #guesserStreetView {
      width:100%;
      height:280px;
      border-radius:8px;
      background:#0A1630;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:bold;
      color:#9bb5ff;
      margin-bottom:8px;
    }

    .status {
      font-weight:600;
      margin-top:6px;
      color: var(--text-accent);
    }

    .hint {
      font-size:0.9rem;
      color:#cbd6ff;
      margin-top:6px;
    }

    /* Mobile */
    @media (max-width: 480px) {
      #map, #guessMap, #guesserStreetView {
        height: 240px;
        min-height: 240px;
      }
    }
  </style>
</head>

<body>

<div id="left">

  <img id="logo" src="/geofavicon/logo.png" alt="GeoBrawl Logo">

  <h2>GeoBrawl</h2>

  <!-- Lobby -->
  <div class="panel" id="lobbyControls">
    <button id="createBtn">Create Room</button>

    <input id="roomInput" placeholder="Enter Room Code (e.g. ABC123)" />
    <button id="joinBtn">Join Room</button>

    <div class="hint">Open the same room in another browser to play (2 players).</div>
  </div>

  <!-- Room -->
  <div class="panel" id="roomPanel" style="display:none;">
    <div>Room: <span id="roomIdSpan" style="color:var(--text-accent)"></span></div>
    <div>Players: <ul id="playersList"></ul></div>
    <div>Scores: <pre id="scoresPre"></pre></div>
    <div class="status" id="statusText">Waiting for players...</div>
  </div>

  <!-- Picker panel -->
  <div class="panel" id="pickerPanel" style="display:none;">
    <h3 style="color:var(--text-accent)">Picker — Street View on Map</h3>
    <p>Move Street View on the map and click "Spot Chosen".</p>

    <input id="hintInput" placeholder="Optional hint (e.g. 'Near a famous river')" />
    <button id="submitPickBtn" disabled>Spot Chosen</button>

    <div id="pickerMapContainer">
      <div id="map"></div>
    </div>
  </div>

  <!-- Guesser panel -->
  <div class="panel" id="guesserPanel" style="display:none;">
    <h3 style="color:var(--text-accent)">Guesser — Make your guess</h3>

    <div id="guesserStreetView">Waiting for picker to pick spot...</div>

    <div id="guesserMapContainer">
      <div id="guessMap"></div>
    </div>

    <div id="guessResult" style="margin-top:6px; font-weight:600;"></div>

    <button id="submitGuessBtn" disabled>Submit Guess</button>
  </div>

  <!-- Result -->
  <div class="panel" id="resultPanel" style="display:none;">
    <h3 style="color:var(--text-accent)">Round Result</h3>
    <div id="resultText"></div>
  </div>

</div>

<!-- Load Socket.IO first so `io()` exists for our script -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<!-- ALL YOUR GAME JS -->
<script>
/* ================================
   GeoBrawl — Full JS (USA-only)
   Clean: initMapsSetup + wrapper initMaps
   ================================ */

const SERVER_URL = "geo-production-f14c.up.railway.app";
const socket = io(SERVER_URL, { transports: ["websocket"] });

// DOM references
const createBtn = document.getElementById('createBtn');
const joinBtn = document.getElementById('joinBtn');
const roomInput = document.getElementById('roomInput');
const roomPanel = document.getElementById('roomPanel');
const roomIdSpan = document.getElementById('roomIdSpan');
const playersList = document.getElementById('playersList');
const scoresPre = document.getElementById('scoresPre');
const statusText = document.getElementById('statusText');
const pickerPanel = document.getElementById('pickerPanel');
const guesserPanel = document.getElementById('guesserPanel');
const submitPickBtn = document.getElementById('submitPickBtn');
const submitGuessBtn = document.getElementById('submitGuessBtn');
const hintInput = document.getElementById('hintInput');
const resultPanel = document.getElementById('resultPanel');
const resultText = document.getElementById('resultText');
const guesserStreetViewDiv = document.getElementById('guesserStreetView');
const guessMapDiv = document.getElementById('guessMap');
const guessResultDiv = document.getElementById('guessResult');

// Game state
let myRoomId = null;
let mySocketId = null;
let players = [];
let scores = {};
let currentPickerId = null;

// Maps / StreetView state
let pickerMap = null;
let pickerStreetView = null;
let pickerLatLng = null;

let guessMap = null;
let guessMarker = null;
let guesserPanorama = null;

// USA bounding box (approximate continental USA bounds)
const USA_BOUNDS = {
  minLat: 24.396308,
  maxLat: 49.384358,
  minLng: -124.848974,
  maxLng: -66.885444
};

function isInsideUSA(lat, lng) {
  if (typeof lat !== 'number' || typeof lng !== 'number') return false;
  return (
    lat >= USA_BOUNDS.minLat &&
    lat <= USA_BOUNDS.maxLat &&
    lng >= USA_BOUNDS.minLng &&
    lng <= USA_BOUNDS.maxLng
  );
}

/* ----------------------------
   Maps initialization (real setup)
   ---------------------------- */
function initMapsSetup() {
pickerMap = new google.maps.Map(document.getElementById("map"), {
  center:{lat:40,lng:-99},
  zoom:2,
  streetViewControl:true,
  gestureHandling: "greedy"
});


  pickerStreetView = pickerMap.getStreetView();
  pickerStreetView.setVisible(true);

  // Listen to position changes and enforce USA bounds
  pickerStreetView.addListener("position_changed", () => {
    const pos = pickerStreetView.getPosition();
    if (!pos) {
      // No position yet
      pickerLatLng = null;
      submitPickBtn.disabled = true;
      return;
    }

    const lat = pos.lat();
    const lng = pos.lng();

    // If not inside USA, disable submission and show message
    if (!isInsideUSA(lat, lng)) {
      pickerLatLng = null;
      submitPickBtn.disabled = true;
      submitPickBtn.textContent = "Pick a location INSIDE the USA";
      submitPickBtn.style.background = "#944"; // visual cue
      return;
    }

    // Valid USA position
    pickerLatLng = { lat, lng };

    // Only enable if current player is the picker
    if (currentPickerId === mySocketId) {
      submitPickBtn.disabled = false;
    }

    submitPickBtn.textContent = "Spot Chosen";
    submitPickBtn.style.background = ""; // reset styling
  });

  // Guess map (where guesser places a marker)
  guessMap = new google.maps.Map(guessMapDiv, {
    center: { lat: 39.8283, lng: -98.5795 },
    zoom: 4
  });

  // Clicking on guessMap selects a guess — but only allow USA positions
  guessMap.addListener("click", e => {
    // If the user is the picker, ignore clicks
    if (currentPickerId === mySocketId) return;

    const lat = e.latLng.lat();
    const lng = e.latLng.lng();

    // Enforce USA-only guesses
    if (!isInsideUSA(lat, lng)) {
      // Provide a visible message and do not place marker
      alert("Guesses must be inside the USA. Click somewhere within the continental United States.");
      return;
    }

    // Place or move marker
    if (guessMarker) guessMarker.setMap(null);
    guessMarker = new google.maps.Marker({
      position: { lat, lng },
      map: guessMap
    });

    // Enable submit guess button
    submitGuessBtn.disabled = false;

    // Set onclick to emit guess
    submitGuessBtn.onclick = () => {
      // Defensive check: ensure marker exists and inside USA
      if (!guessMarker) return;
      const p = guessMarker.getPosition();
      if (!isInsideUSA(p.lat(), p.lng())) {
        alert("Your guess must be inside the USA.");
        return;
      }
      socket.emit("makeGuess", { roomId: myRoomId, lat: p.lat(), lng: p.lng() });
      submitGuessBtn.disabled = true;
    };
  });
}

/* ----------------------------
   Wrapper called by Google Maps API
   ---------------------------- */
function initMaps() {
  try {
    // Call the real setup function
    if (typeof initMapsSetup === 'function') {
      initMapsSetup();
    } else {
      console.error("initMapsSetup() not defined");
    }
  } catch (e) {
    console.error("initMaps wrapper error:", e);
  }
}

/* ----------------------------
   Pick submission (picker)
   ---------------------------- */
submitPickBtn.onclick = () => {
  if (!pickerLatLng) {
    alert("Move Street View inside the USA to pick a spot!");
    return;
  }

  if (!isInsideUSA(pickerLatLng.lat, pickerLatLng.lng)) {
    alert("Your Street View location must be inside the USA.");
    return;
  }

  socket.emit("pickLocation", {
    roomId: myRoomId,
    lat: pickerLatLng.lat,
    lng: pickerLatLng.lng,
    hint: hintInput.value
  });

  submitPickBtn.disabled = true;
  submitPickBtn.textContent = "Spot Chosen";
};

/* ----------------------------
   Socket events & UI actions
   ---------------------------- */

// Connect
socket.on("connect", () => {
  mySocketId = socket.id;
});

// Create room
createBtn.onclick = () => {
  socket.emit("createRoom", res => {
    if (res && res.ok) {
      myRoomId = res.roomId || res.room;
      roomIdSpan.textContent = myRoomId;
      roomPanel.style.display = "";
      document.getElementById("lobbyControls").style.display = "none";
    } else if (res && res.err) {
      alert("Create room error: " + res.err);
    }
  });
};

// Join room
joinBtn.onclick = () => {
  const r = roomInput.value.trim().toUpperCase();
  if (!r) return alert("Enter a room code");
  socket.emit("joinRoom", r, res => {
    if (!res || !res.ok) return alert(res ? res.err : "Failed to join room");
    myRoomId = r;
    roomIdSpan.textContent = myRoomId;
    roomPanel.style.display = "";
    document.getElementById("lobbyControls").style.display = "none";
  });
};

// When room joined/updated
socket.on("roomJoined", data => {
  if (!data) return;
  players = data.players || players;
  scores = data.scores || scores;
  currentPickerId = data.pickerSocketId || currentPickerId;
  updateLobbyUI();
  updateRolePanels();
});

// When a round starts: show guesser Street View for the guesser
socket.on("startGuess", data => {
  guesserPanel.style.display = "";
  pickerPanel.style.display = "none";
  statusText.textContent = "Make your guess…";
  guesserStreetViewDiv.innerHTML = "";

  // Create a StreetView panorama for the guesser to view the chosen spot
  guesserPanorama = new google.maps.StreetViewPanorama(guesserStreetViewDiv, {
    position: { lat: data.lat, lng: data.lng },
    pov: { heading: 0, pitch: 0 },
    zoom: 1,
    disableDefaultUI: true,
    clickToGo: false,
    linksControl: false
  });

  // Reset guess map view and markers
  guessMap.setCenter({ lat: 39.8283, lng: -98.5795 });
  guessMap.setZoom(4);
  if (guessMarker) {
    guessMarker.setMap(null);
    guessMarker = null;
  }
  guessResultDiv.innerHTML = "";
  submitGuessBtn.disabled = true;
});

// When round result arrives
socket.on("roundResult", res => {
  resultPanel.style.display = "";
  resultText.innerHTML = `Distance: <b>${res.distanceMeters} m</b><br>Points: <b>${res.pointsAwarded}</b>`;
  scores = res.scores || scores;
  updateScoresUI();

  // Mark correct spot on guessMap
  new google.maps.Marker({
    position: { lat: res.correct.lat, lng: res.correct.lng },
    map: guessMap,
    icon: "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
  });

  guessResultDiv.innerHTML = `Distance: <b>${res.distanceMeters} m</b> — Points: <b>${res.pointsAwarded}</b>`;
});

// New round event (reset UI)
socket.on("newRound", data => {
  currentPickerId = data.pickerSocketId;
  scores = data.scores || scores;
  resultPanel.style.display = "none";
  guesserStreetViewDiv.innerHTML = "Waiting for picker to pick spot...";
  guessResultDiv.innerHTML = "";
  if (guessMarker) {
    guessMarker.setMap(null);
    guessMarker = null;
  }
  guessMap.setCenter({ lat: 39.8283, lng: -98.5795 });
  guessMap.setZoom(4);
  updateScoresUI();
  updateRolePanels();
});

/* ----------------------------
   UI helpers
   ---------------------------- */
function updateLobbyUI() {
  // Show readable player list: convert socket ids to "You" when matching
  playersList.innerHTML = "";
  (players || []).forEach(p => {
    const li = document.createElement('li');
    li.textContent = (p === mySocketId) ? "You" : p;
    playersList.appendChild(li);
  });
  updateScoresUI();
}

function updateScoresUI() {
  scoresPre.textContent = JSON.stringify(scores, null, 2);
}

function updateRolePanels() {
  // Hide panels if fewer than 2 players
  if (!players || players.length < 2) {
    pickerPanel.style.display = "none";
    guesserPanel.style.display = "none";
    statusText.textContent = "Waiting for another player…";
    return;
  }

  // If current player is the picker
  if (currentPickerId === mySocketId) {
    statusText.textContent = "You are the picker.";
    pickerPanel.style.display = "";
    guesserPanel.style.display = "none";

    // If pickerStreetView's position is inside USA, enable button
    if (pickerLatLng && isInsideUSA(pickerLatLng.lat, pickerLatLng.lng)) {
      submitPickBtn.disabled = false;
      submitPickBtn.textContent = "Spot Chosen";
      submitPickBtn.style.background = "";
    } else {
      submitPickBtn.disabled = true;
      submitPickBtn.textContent = "Pick a location INSIDE the USA";
      submitPickBtn.style.background = "#944";
    }
  } else {
    statusText.textContent = "You are the guesser.";
    pickerPanel.style.display = "none";
    guesserPanel.style.display = "";
    submitGuessBtn.disabled = true;
  }
}

/* ----------------------------
   Defensive logging handlers
   ---------------------------- */
window.addEventListener('error', (evt) => {
  console.error('Window error:', evt.error || evt.message);
});
window.addEventListener('unhandledrejection', (evt) => {
  console.error('Unhandled promise rejection:', evt.reason);
});
</script>

<!-- Google Maps - load last so initMaps exists when the API calls it -->
<script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCQHZHmpF-9_7jEixW8z_h_-zbImwnI3S0&callback=initMaps"></script>

</body>
</html>
